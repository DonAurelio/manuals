# Product Creation

The datacube needs to know about the properies of the scenes produced for every satellite we are interested in. As every satellite takes different **measuremets**, then every image will have different data. The datacube needs to care about organizing data of images from the same satellite together. For each satellite a **Product** must be created in the datacube. Then scenes from the same satellite corresponds with the same datacube Product. 

Start the container configured on the first section and copy the scene downloaded into the *data* directory. Then check that the scene is in the container */data* directory.

```sh
(base) cube@7f5f41421fc7:~$ ls data/
LC080050572018120901T1-SC20190909195342.tar.gz  README.md
```

Initialize the datacube database 

```sh 
datacube -v system init
```

Check datacube database connection

```sh 
datacube system check

Version:       1.6.1+0.gee3c3d81.dirty
Config files:  /opt/custom-config.conf
Host:          localhost:5432
Database:      datacube
User:          cube
Environment:   None
Index Driver:  default

Valid connection:	YES
```

## Create a the product LS8_OLI_LASRC for Landsat 8 Scenes

To define a new Product, a **Product Definition Document** is required. This file will describe the data that will be contained for the given Product, more information about this in [1]. A definition files is available on this repository.

```sh 
git clone https://github.com/DonAurelio/manuals.git
```
Copy the Landsat 8 files into the */dc_storage*

```sh 
cp -r manuals/open-datacube/products/LS8_OLI_LASRC /dc_storage/
```

Create the landsat 8 product

```sh 
datacube product add /dc_storage/LS8_OLI_LASRC/description_file.yml

Added "ls8_collections_sr_scene"
```

List the Products created on the datacube

```sh 
datacube product list

creation_time: null
description: Landsat 8 USGS Collection 1 Higher Level SR scene proessed using LaSRC.
    30m UTM based projection.
format: GeoTiff
id: 1
instrument: OLI_TIRS
label: null
lat: null
lon: null
name: ls8_collections_sr_scene
platform: LANDSAT_8
product_type: LaSRC
time: null
```

## Data Indexing and Ingestion

Scenes are indexed on the datacube database for ease acces such data through the datacube Python API. An optional step performed by the datacube is the ingestion. This step divide the scene in pieces called tiles. This pieces are stored in dc_stoarge and improve the performance on queries made to the datacube, more details in [2]. 

Create a folder for the landsat 8 scenes we are intended to index (and ingest) in */source_storage*

```sh 
mkdir /source_storage/LS8_OLI_LASRC
```

Copy the .tar.gz file you copied in /datacube_shared in /source_storage

```sh 
cp ~/data/LC080050572018122501T1-SC20190910190636.tar.gz /source_storage/LS8_OLI_LASRC
```

Copy the ingestion script into the hoem directory

```sh 
cp manuals/open-datacube/scripts/IngestBatch.sh ~
```

Index an ingest the scene using the script. If the password of the **cube** user is requested use **cube**. 

```sh 
./IngestBatch.sh /source_storage/LS8_OLI_LASRC/ /dc_storage/LS8_OLI_LASRC/ingest_file.yml /dc_storage/LS8_OLI_LASRC/mgen_script.py
```

Check that no failed tasks take place

```sh 
8 successful, 0 failed
```

# References

1. [Product](https://datacube-core.readthedocs.io/en/latest/architecture/data_model.html#product)
2. [Indexing Data](https://datacube-core.readthedocs.io/en/latest/ops/indexing.html#indexing-data)

Install sudo apt install libgdal-dev